package uk.gov.moj.cpp.prosecution.casefile.command.api.accesscontrol;import static org.hamcrest.MatcherAssert.assertThat;import static org.hamcrest.Matchers.hasItem;import static org.hamcrest.Matchers.hasSize;import static org.hamcrest.Matchers.is;import static org.mockito.BDDMockito.given;import static org.mockito.Mockito.times;import static org.mockito.Mockito.verify;import static uk.gov.justice.services.test.utils.core.messaging.MetadataBuilderFactory.metadataOf;import uk.gov.justice.services.test.utils.core.messaging.JsonEnvelopeBuilder;import uk.gov.moj.cpp.accesscontrol.common.providers.UserAndGroupProvider;import uk.gov.moj.cpp.accesscontrol.drools.Action;import uk.gov.moj.cpp.accesscontrol.test.utils.BaseDroolsAccessControlTest;import java.util.HashMap;import java.util.Map;import java.util.UUID;import com.fasterxml.jackson.core.JsonProcessingException;import com.google.common.collect.ImmutableMap;import org.junit.jupiter.api.Test;import org.junit.jupiter.api.extension.ExtendWith;import org.kie.api.runtime.ExecutionResults;import org.mockito.Mock;import org.mockito.junit.jupiter.MockitoExtension;@ExtendWith(MockitoExtension.class)public class RuleConstantsTest extends BaseDroolsAccessControlTest{    private Action action;    @Mock    private UserAndGroupProvider userAndGroupProvider;    public RuleConstantsTest() {        super("COMMAND_API_SESSION");    }    @Test    public void shouldAllowAuthorisedUserToInitiateCCProsecution() throws JsonProcessingException {        final Map<String, String> metadata = new HashMap();        metadata.putIfAbsent("id", UUID.randomUUID().toString());        metadata.putIfAbsent("name", "prosecutioncasefile.command.initiate-cc-prosecution");        action = createActionFor(metadata);        given(this.userAndGroupProvider.isMemberOfAnyOfTheSuppliedGroups(action, RuleConstants.getInitiateCCProsecutionGroups())).willReturn(false);        given(userAndGroupProvider.hasPermission(action, RuleConstants.expectedPermissionsForCase())).willReturn(true);        final ExecutionResults results = executeRulesWith(action);        assertSuccessfulOutcome(results);        verify(userAndGroupProvider, times(1)).isMemberOfAnyOfTheSuppliedGroups(action, RuleConstants.getInitiateCCProsecutionGroups());        verify(userAndGroupProvider, times(1)).hasPermission(action, RuleConstants.expectedPermissionsForCase());    }    @Test    public void shouldAllowAuthorisedUserWithPermissionToInitiateCCProsecution() throws JsonProcessingException {        final Map<String, String> metadata = new HashMap();        metadata.putIfAbsent("id", UUID.randomUUID().toString());        metadata.putIfAbsent("name", "prosecutioncasefile.command.initiate-cc-prosecution");        action = createActionFor(metadata);        given(this.userAndGroupProvider.isMemberOfAnyOfTheSuppliedGroups(action, RuleConstants.getInitiateCCProsecutionGroups())).willReturn(false);        given(userAndGroupProvider.hasPermission(action, RuleConstants.expectedPermissionsForCase())).willReturn(true);        final ExecutionResults results = executeRulesWith(action);        assertSuccessfulOutcome(results);        verify(userAndGroupProvider, times(1)).isMemberOfAnyOfTheSuppliedGroups(action, RuleConstants.getInitiateCCProsecutionGroups());        verify(userAndGroupProvider, times(1)).hasPermission(action, RuleConstants.expectedPermissionsForCase());    }    @Test    public void shouldNotAllowUnauthorisedUserToInitiateCCProsecution() throws JsonProcessingException {        final Map<String, String> metadata = new HashMap();        metadata.putIfAbsent("id", UUID.randomUUID().toString());        metadata.putIfAbsent("name", "prosecutioncasefile.command.initiate-cc-prosecution");        action = createActionFor(metadata);        given(this.userAndGroupProvider.isMemberOfAnyOfTheSuppliedGroups(action, RuleConstants.getInitiateCCProsecutionGroups())).willReturn(false);        given(userAndGroupProvider.hasPermission(action, RuleConstants.expectedPermissionsForCase())).willReturn(false);        final ExecutionResults results = executeRulesWith(action);        assertFailureOutcome(results);        verify(userAndGroupProvider, times(1)).isMemberOfAnyOfTheSuppliedGroups(action, RuleConstants.getInitiateCCProsecutionGroups());        verify(userAndGroupProvider, times(1)).hasPermission(action, RuleConstants.expectedPermissionsForCase());    }    @Test    public void shouldReturnRelatedGroups(){        assertThat(RuleConstants.getStartProceedingsActionGroups(), hasSize(1));        assertThat(RuleConstants.getStartProceedingsActionGroups().get(0), is("CMS"));        assertThat(RuleConstants.getAssignHearingActionGroups(), hasSize(1));        assertThat(RuleConstants.getAssignHearingActionGroups().get(0), is("CMS"));        assertThat(RuleConstants.getInitiateSjpProsecutionGroups(), hasSize(3));        assertThat(RuleConstants.getInitiateSjpProsecutionGroups().get(0), is("System Users"));        assertThat(RuleConstants.getInitiateSjpProsecutionGroups().get(1), is("Court Administrators"));        assertThat(RuleConstants.getInitiateSjpProsecutionGroups().get(2), is("Legal Advisers"));        assertThat(RuleConstants.getUpdateErrorsActionGroups(), hasSize(5));        assertThat(RuleConstants.getUpdateErrorsActionGroups().get(0), is("Crown Court Admin"));        assertThat(RuleConstants.getUpdateErrorsActionGroups().get(1), is("Listing Officers"));        assertThat(RuleConstants.getUpdateErrorsActionGroups().get(2), is("Court Clerks"));        assertThat(RuleConstants.getUpdateErrorsActionGroups().get(3), is("Legal Advisers"));        assertThat(RuleConstants.getUpdateErrorsActionGroups().get(4), is("Court Administrators"));        assertThat(RuleConstants.getInitiateCCApplicationGroups(), hasSize(6));        assertThat(RuleConstants.getInitiateCCApplicationGroups().get(0), is("System Users"));        assertThat(RuleConstants.getInitiateCCApplicationGroups().get(1), is("Listing Officers"));        assertThat(RuleConstants.getInitiateCCApplicationGroups().get(2), is("Legal Advisers"));        assertThat(RuleConstants.getInitiateCCApplicationGroups().get(3), is("Court Administrators"));        assertThat(RuleConstants.getInitiateCCApplicationGroups().get(4), is("Crown Court Admin"));        assertThat(RuleConstants.getInitiateCCApplicationGroups().get(5), is("Court Clerks"));        assertThat(RuleConstants.getAddMaterialActionGroups(), hasSize(1));        assertThat(RuleConstants.getAddMaterialActionGroups().get(0), is("System Users"));        assertThat(RuleConstants.getAddMaterialIdpcActionGroups(), hasSize(1));        assertThat(RuleConstants.getAddMaterialIdpcActionGroups().get(0), is("System Users"));        assertThat(RuleConstants.getUpdateErrorsActionGroups(), hasSize(5));        assertThat(RuleConstants.getUpdateErrorsActionGroups().get(0), is("Crown Court Admin"));        assertThat(RuleConstants.getUpdateErrorsActionGroups().get(1), is("Listing Officers"));        assertThat(RuleConstants.getUpdateErrorsActionGroups().get(2), is("Court Clerks"));        assertThat(RuleConstants.getUpdateErrorsActionGroups().get(3), is("Legal Advisers"));        assertThat(RuleConstants.getUpdateErrorsActionGroups().get(4), is("Court Administrators"));        assertThat(RuleConstants.getPleadOnlineActionGroups(), hasSize(1));        assertThat(RuleConstants.getPleadOnlineActionGroups().get(0), is("Online Plea System Users"));        assertThat(RuleConstants.getPleadOnlinePcqVisitedActionGroups(), hasSize(1));        assertThat(RuleConstants.getPleadOnlinePcqVisitedActionGroups().get(0), is("Online Plea System Users"));    }    @Override    protected Map<Class<?>, Object> getProviderMocks() {        return ImmutableMap.<Class<?>, Object>builder().put(UserAndGroupProvider.class, userAndGroupProvider).build();    }    @Override    protected Action createActionFor(final Map<String, String> metadata) {        JsonEnvelopeBuilder jsonEnvelopeBuilder = JsonEnvelopeBuilder.envelope().withPayloadOf(UUID.randomUUID().toString(), "caseId");        return new Action(jsonEnvelopeBuilder.with(metadataOf(UUID.randomUUID().toString(), metadata.get("name"))).build());    }}